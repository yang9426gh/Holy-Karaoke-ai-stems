name: windows-offline-installer

on:
  workflow_dispatch:
  push:
    branches: [ main, master ]

jobs:
  build-win:
    runs-on: windows-latest
    defaults:
      run:
        shell: pwsh

    env:
      # avoid code signing auto-discovery prompts
      CSC_IDENTITY_AUTO_DISCOVERY: "false"
      ELECTRON_BUILDER_ALLOW_UNRESOLVED_DEPENDENCIES: "true"

    steps:
      - uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
          cache-dependency-path: |
            frontend/package-lock.json
            mac-app/package-lock.json

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: pip
          cache-dependency-path: backend/requirements.txt

      - name: Build frontend static (Next export)
        working-directory: frontend
        run: |
          npm ci
          npm run build

      - name: Download vendor binaries (ffmpeg, yt-dlp)
        working-directory: backend
        run: |
          New-Item -ItemType Directory -Force -Path vendor | Out-Null

          # ffmpeg (static build)
          $ffUrl = "https://www.gyan.dev/ffmpeg/builds/ffmpeg-release-essentials.zip"
          $ffZip = "ffmpeg.zip"
          Invoke-WebRequest -Uri $ffUrl -OutFile $ffZip
          Expand-Archive -Force $ffZip -DestinationPath vendor\ffmpeg
          Remove-Item $ffZip

          # locate ffmpeg.exe and ffprobe.exe
          $ffmpegExe = Get-ChildItem -Recurse -Filter ffmpeg.exe vendor\ffmpeg | Select-Object -First 1
          $ffprobeExe = Get-ChildItem -Recurse -Filter ffprobe.exe vendor\ffmpeg | Select-Object -First 1
          if (!$ffmpegExe) { throw "ffmpeg.exe not found in downloaded zip" }
          Copy-Item $ffmpegExe.FullName -Destination vendor\ffmpeg.exe -Force
          if ($ffprobeExe) { Copy-Item $ffprobeExe.FullName -Destination vendor\ffprobe.exe -Force }

          # yt-dlp.exe
          $ytdlpUrl = "https://github.com/yt-dlp/yt-dlp/releases/latest/download/yt-dlp.exe"
          Invoke-WebRequest -Uri $ytdlpUrl -OutFile vendor\yt-dlp.exe

          # cleanup extracted ffmpeg tree (keep only the .exe files)
          Remove-Item -Recurse -Force vendor\ffmpeg

      - name: Build backend exe (PyInstaller)
        working-directory: backend
        run: |
          python -m pip install --upgrade pip wheel
          python -m pip install -r requirements.txt
          python -m pip install pyinstaller
          pyinstaller -y pyinstaller_backend.spec

      - name: Stage backend (PyInstaller one-folder) into backend-bin/
        run: |
          New-Item -ItemType Directory -Force -Path backend-bin | Out-Null

          $src = "backend\\dist\\holy-backend"
          if (!(Test-Path $src)) { throw "PyInstaller output folder not found: $src" }

          # Copy the entire one-folder distribution (exe + dll/pyd/libs)
          Copy-Item -Recurse -Force "$src\\*" -Destination backend-bin

          if (!(Test-Path "backend-bin\\holy-backend.exe")) {
            $exe = Get-ChildItem -Recurse -Filter holy-backend.exe backend-bin | Select-Object -First 1
            throw "holy-backend.exe not found in backend-bin (found: $($exe.FullName))"
          }

      - name: Build Electron Windows installer (NSIS)
        working-directory: mac-app
        run: |
          npm ci
          npm run dist:win

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: HolyKaraoke-windows-offline
          path: |
            mac-app/dist/*.exe
            mac-app/dist/*.yml
            mac-app/dist/*.blockmap
